---
title: "Plot and analysis"
output: html_notebook
---

In this notebook, we analyze whether species richness and chain motives modulate the relationship between FCL and three enviornmental factors (resource availability, disturbances, and ecosystem sizes).
As we provide summary csv file for the database, one can skip
```{r Processing Cohen database}
library(tidyverse)
library(igraph)
library(Matrix)
FCLmean=function(A){
  # A: an adjacency matrix of directed food web
  N = nrow(A) # number of species in the food web
  # Check/Convert weighted matrix
  if(any(colSums(A)>1)){
    for(i in 1:N){
      if (sum(A[, i])>0){
        A[,i]=A[,i]/sum(A[, i])
      }
    }
  }
  if (rankMatrix(t(A-diag(N)))<N){
    # Then, we CANNNOT calculate either trophic levels or FCL in the food web 
    return (NaN)
  }else{
    # We can find unique trophic levels and FCL from the following linear equation
    TL=solve(t(A-diag(N)), rep(-1, N))
    
  return (max(TL)-1) # FCL= max TL -1
  }
}

FCL=function(A, def=-1){
  # A: an adjacency matrix of directed food web
  # def: definition of FCL. We choose one definition from below
  # def =-1: shortest-path
  # def = 1: longest-path. Only acyclic graph
  
  N = nrow(A) # number of species in the food web
  TL=rep(0, N)
  B=c()
  # Check the indexes of basal species
  for (i in 1:N){
    if (sum(A[, i])==0){
      TL[i]=1 # basal species
      B=c(B, i) # list of basal species
    }
  }
  
  # Check whether A is DAG or not
  # calculate trophic levels 
  
  
  for (i in 1:N){
    if(TL[i]==0){
      # analyze nob-basal species
      if (def==0){
          # we define FCL by mean prey's tropic level
          TL[i] = 1+(TL[1:(i-1)]%*%A[1:(i-1), i])/sum(A[1:(i-1), i])
      }
      else if (def==-1){
          # TL of species i is defined by 1+the shortest path from a basal species
          graph=graph_from_adjacency_matrix(A,mode='directed')
          TL[i] = 1+min(distances(graph,to = i, mode='out')[B]) 
      }
      else if (def==1){
          #TL of species i is defined by 1+the longest path from a basal species
          # Because igraph does not have an algorithm for the longest path
          # we will use the shortest path with negative weights
          graph=graph_from_adjacency_matrix(-A,mode='directed', weight=TRUE)
          TL[i] =1- min(distances(graph,to = i, mode='out')[B]) # we only care distances from basal species to species i
      }
    }
  }
 #print(TL)
  return (max(TL)-1) # FCL= max TL -1
}
# define A 

# read from Data base
Analysis = function (d){
  # d row csv file
  # return FCLs and number fo the motives
  D=d[, 4:ncol(d)] # because of separaters of the file, we have empty two cols, Third col represents id of preys
  #rownames(D)=d[, 3]
  #colnames(D)=d[1,4:ncol(d) ]
  A=data.frame(D)
  colnames(A)=colnames(D)
  rownames(A)=as.character(unlist(d[, 3]))
  for (i in 1:nrow(A)){
    if (as.integer(rownames(A))[i]<10){
      rownames(A)[i] = paste0("0",rownames(A)[i])
    }
  }
  
  for (i in 1:ncol(A)){
    if (as.integer(colnames(A))[i]<10){
      colnames(A)[i] = paste0("0",colnames(A)[i])
    }
  }
  # We need to convert a data into NxN matrix
  N_list=sort(unique(c(rownames(A), colnames(A)))) # total number of species in the food web
  col_check=!(N_list %in% colnames(A)) # which species is missing in columns?
  row_check=!(N_list %in% rownames(A)) # which species is missing in rows?
  for(i in 1:length(N_list)){
    if (col_check[i]==TRUE){
       add = rep(0, nrow(A))
       a=cbind(A, add)
       #if(i<10){
       #  colnames(a)=c(colnames(A), paste0("0",N_list[0]))
       #}else{
        # colnames(a)=c(colnames(A), paste0(N_list[i]))
       #}
       colnames(a)=c(colnames(A), paste0(N_list[i]))
       A= a %>% select(all_of(names(a) %>% sort())) # update A and sorting
    }
    if (row_check[i]==TRUE){
       add = rep(0, ncol(A))
       a=rbind(A, add)
       #if(i<10){
      #   rownames(a)=c(rownames(A), paste0("0",N_list[i]))
      # }else{
       #  rownames(a)=c(rownames(A), paste0(N_list[i]))
       #}
       rownames(a)=c(rownames(A), paste0(N_list[i]))
       A=a %>% arrange(rownames(a)) # update A and sorting
    }
  } 
  A=matrix(unlist(A), ncol=ncol(A))  # convert matrix so that we can use it in igraph
  graph=graph_from_adjacency_matrix(A,mode='directed')
  if (is.dag(graph)==TRUE){
  FCL_mean=FCLmean(A) # FCL based on mean prey trophic level
    # convert weighted adj into unweighted one
    A =matrix(as.integer(A>0), nrow=nrow(A))
    FCL_long = FCL(A, 1)
  }else{
  # In this case, two FCLs cannot be defined
  FCL_mean=FCLmean(A)
  FCL_long=NaN
  # convert weighted adj into unweighted one
  A =matrix(as.integer(A>0), nrow=nrow(A))
  }
  FCL_short =FCL(A, -1) # this can be defined in any food webs. Return Inf without basal species
  
  motif=matrix(triad_census(graph), nrow=1)
  # the names of the motives follow previous studies
  data=data.frame(FCL_short, FCL_mean, FCL_long, nrow(A), motif)
  colnames(data) = c('FCL_short', 'FCL_mean', 'FCL_long',"richness", 
                    "empty","monoA-single","bi-single",
                    "s5","s4","s1","d4","d3","s2",
                    "s3","d8","d2","d1","d5","d7","d6")
  return (data)
}
#---------------MAIN-----------------------------
for(i in 1:213){
  fname=paste0('./EmpiricalFoodWeb/ECOWeB1.1/DATFILES Predation Matrices/WEB',i,'.DAT') # path of the files
  d=read_csv(fname)
  if (i==1){
  data=Analysis(d)
  }else{
    data=rbind(data, Analysis(d))
  }
write.csv(data, "Cohen2010_summary.csv", row.names = FALSE)
}
  
```
Now we analyze the data.
First, we investigate whether species richness and food web motives correlate with FCL or not.
```{r Read csv data}
library(ggplot2)
library(patchwork)
library(tidyverse)

df_emp=read.csv("Cohen2010_summary.csv") # empirical data
df_long=read.csv("./Simulations/FCL_long_simulations_summary.csv") # simulation using FCL long
df_mean=read.csv("./Simulations/FCL_mean_simulations_summary.csv") # simulation using FCL mean
df_short=read.csv("./Simulations/FCL_short_simulations_summary.csv") # simulation using FCL short

# Preparing data analysis
# For df_emp, we removed unnecessary columns and convert the count data of motives into fractions
df_emp = subset(df_emp, select = -c(empty,monoA.single, bi.single) )
df_emp=df_emp %>% select(order(colnames(df_emp)))
df_emp=dplyr::select(df_emp, WEB_id,Ecosystem, FCL_long,FCL_mean, FCL_short,richness,Ecosystem, everything())
sum.motif=apply(df_emp[, 7:ncol(df_emp)], 1, sum) # sum of motives in each row
df_emp[, 7:ncol(df_emp)] = df_emp[, 7:ncol(df_emp)]/sum.motif # converting into fractions of motives
# we remove motives that do not  or rarely appear
df_emp = subset(df_emp, select = -c(WEB_id, d1, d2,d3, d4, s3, d5, d6, d7,d8) )
colnames(df_emp) = c('Ecosystems', 'FCL_long', 'FCL_mean', 'FCL_short', 'Richness', 
                 'Chain', 'Omnivory', 'Apparent', 'Exploitative')
```
Next we plot FCL against the richness and motives 

```{r Empirical richness and motives}
r1=ggplot(df_emp, aes(x=Richness, y=FCL_long))+ylab('FCL long')+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+annotate(geom="text", x=40, y=9, label=paste0('corr.=', round(cor.test(na.omit(df_emp)$FCL_long, na.omit(df_emp)$Richness, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(na.omit(df_emp)$FCL_long, na.omit(df_emp)$Richness, method='spearman')$p.value, 3)), size=5)

# Note df_emp$FCL_long includes some NA because of cyclic food webs
r2=ggplot(df_emp, aes(x=Richness, y=FCL_mean))+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+ylab('FCL mean')+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+annotate(geom="text", x=40, y=4.5, label=paste0('corr.=', round(cor.test(df_emp$FCL_mean, df_emp$Richness, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_mean, df_emp$Richness, method='spearman')$p.value, 3)), size=5)

r3=ggplot(df_emp, aes(x=Richness, y=FCL_short))+ylab('FCL short')+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+annotate(geom="text", x=40, y=3.75, label=paste0('corr.=', round(cor.test(df_emp$FCL_short, df_emp$Richness, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_short, df_emp$Richness, method='spearman')$p.value, 3)), size=5)

m1=ggplot(df_emp, aes(x=Chain, y=FCL_long))+geom_point(color = "#a6cee3", alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_emp$FCL_long, df_emp$Chain, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_long, df_emp$Chain, method='spearman')$p.value, 3)), size=5)

m2=ggplot(df_emp, aes(x=Omnivory, y=FCL_long))+ylab('FCL long')+geom_point(color = '#1f78b4', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )  +xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_emp$FCL_long, df_emp$Omnivory, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_long, df_emp$Omnivory, method='spearman')$p.value, 3)), size=5)

m3=ggplot(df_emp, aes(x=Apparent, y=FCL_long))+ylab('FCL long')+geom_point(color = '#b2df8a', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_emp$FCL_long, df_emp$Apparent, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_long, df_emp$Apparent, method='spearman')$p.value, 3)), size=5)

m4=ggplot(df_emp, aes(x=Exploitative, y=FCL_long))+ylab('FCL long')+geom_point(color = '#33a02c', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_emp$FCL_long, df_emp$Exploitative, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_long, df_emp$Exploitative, method='spearman')$p.value, 3)), size=5)


m5=ggplot(df_emp, aes(x=Chain, y=FCL_mean))+geom_point(color = "#a6cee3", alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=4.5, label=paste0('corr.=', round(cor.test(df_emp$FCL_mean, df_emp$Chain, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_mean, df_emp$Chain, method='spearman')$p.value, 3)), size=5)

m6=ggplot(df_emp, aes(x=Omnivory, y=FCL_mean))+ylab('FCL mean')+geom_point(color = '#1f78b4', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )   +xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=4.5, label=paste0('corr.=', round(cor.test(df_emp$FCL_mean, df_emp$Omnivory, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_mean, df_emp$Omnivory, method='spearman')$p.value, 3)), size=5)

m7=ggplot(df_emp, aes(x=Apparent, y=FCL_mean))+ylab("FCL mean")+geom_point(color = '#b2df8a', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=4.5, label=paste0('corr.=', round(cor.test(df_emp$FCL_mean, df_emp$Apparent, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_mean, df_emp$Apparent, method='spearman')$p.value, 3)), size=5)

m8=ggplot(df_emp, aes(x=Exploitative, y=FCL_mean))+ylab('FCL mean')+geom_point(color = '#33a02c', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=4.5, label=paste0('corr.=', round(cor.test(df_emp$FCL_mean, df_emp$Exploitative, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_mean, df_emp$Exploitative, method='spearman')$p.value, 3)), size=5)

m9=ggplot(df_emp, aes(x=Chain, y=FCL_short))+ylab("FCL short")+geom_point(color = "#a6cee3", alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=3.75, label=paste0('corr.=', round(cor.test(df_emp$FCL_short, df_emp$Chain, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_short, df_emp$Chain, method='spearman')$p.value, 3)), size=5)

m10=ggplot(df_emp, aes(x=Omnivory, y=FCL_short))+ylab('FCL short')+geom_point(color = '#1f78b4', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )   +xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=3.75, label=paste0('corr.=', round(cor.test(df_emp$FCL_short, df_emp$Omnivory, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_short, df_emp$Omnivory, method='spearman')$p.value, 3)), size=5)

m11=ggplot(df_emp, aes(x=Apparent, y=FCL_short))+ylab('FCL short')+geom_point(color = '#b2df8a', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=3.75, label=paste0('corr.=', round(cor.test(df_emp$FCL_short, df_emp$Apparent, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_short, df_emp$Apparent, method='spearman')$p.value, 3)), size=5)

m12=ggplot(df_emp, aes(x=Exploitative, y=FCL_short))+ylab('FCL short')+geom_point(color = '#33a02c', alpha=0.3, size=5)+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=3.75, label=paste0('corr.=', round(cor.test(df_emp$FCL_short, df_emp$Exploitative, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(df_emp$FCL_short, df_emp$Exploitative, method='spearman')$p.value, 3)), size=5)

g=r1+r2+r3+m1+m5+m9+m2+m6+m10+m3+m7+m11+m4+m8+m12+plot_layout(nrow = 5, ncol=3)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))

ggsave('./empirical_pdf/FCL_empirical.pdf', width=12, height=12)
```

```{r Simulated richness and motives}
# Note: if richness =0 or 1 => motives cannot be defined and correponding data are removed 
r1=ggplot(df_long, aes(x=richness, y=FCL))+ylab("FCL long")+xlab("Richness")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+annotate(geom="text", x=10, y=11, label=paste0('corr.=', round(cor.test(df_long$FCL, df_long$richness, method='spearman')$estimate, 3)), size=5)

r2=ggplot(df_mean, aes(x=richness, y=FCL))+ylab('FCL mean')+xlab("Richness")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+annotate(geom="text", x=10, y=9, label=paste0('corr.=', round(cor.test(df_mean$FCL, df_mean$richness, method='spearman')$estimate, 3)), size=5)

r3=ggplot(df_short, aes(x=richness, y=FCL))+ylab('FCL short')+xlab("Richness")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+annotate(geom="text", x=10, y=9, label=paste0('corr.=', round(cor.test(df_short$FCL, df_short$richness, method='spearman')$estimate, 3)), size=5)

m1=ggplot(df_long, aes(x=chain, y=FCL))+ylab('FCL long')+xlab("Chain")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#a6cee3')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=11, label=paste0('corr.=', round(cor.test(df_long$FCL, df_long$chain, method='spearman')$estimate, 3)), size=5)

m2=ggplot(df_long, aes(x=omnivory, y=FCL))+ylab('FCL long')+xlab("Omnivory")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#1f78b4')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  ) +xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=11, label=paste0('corr.=', round(cor.test(df_long$FCL, df_long$omnivory, method='spearman')$estimate, 3)), size=5)

m3=ggplot(df_long, aes(x=apparent, y=FCL))+ylab('FCL long')+xlab("Apparent")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#b2df8a')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=11, label=paste0('corr.=', round(cor.test(df_long$FCL, df_long$apparent, method='spearman')$estimate, 3)), size=5)

m4=ggplot(df_long, aes(x=exploitative, y=FCL))+ylab('FCL long')+xlab("Exploitative")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#33a02c')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=11, label=paste0('corr.=', round(cor.test(df_long$FCL, df_long$exploitative, method='spearman')$estimate, 3)), size=5)


m5=ggplot(df_mean, aes(x=chain, y=FCL))+ylab('FCL mean')+xlab("Chain")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#a6cee3')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_mean$FCL, df_mean$chain, method='spearman')$estimate, 3)), size=5)

m6=ggplot(df_mean, aes(x=omnivory, y=FCL))+ylab('FCL mean')+xlab("Omnivory")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#1f78b4')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  ) +xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_mean$FCL, df_mean$omnivory, method='spearman')$estimate, 3)), size=5)

m7=ggplot(df_mean, aes(x=apparent, y=FCL))+ylab('FCL mean')+xlab("Apparent")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#b2df8a')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_mean$FCL, df_mean$apparent, method='spearman')$estimate, 3)), size=5)

m8=ggplot(df_mean, aes(x=exploitative, y=FCL))+ylab('FCL mean')+xlab("Exploitative")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#33a02c')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_mean$FCL, df_mean$exploitative, method='spearman')$estimate, 3)), size=5)

m9=ggplot(df_short, aes(x=chain, y=FCL))+ylab('FCL short')+xlab("Chain")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#a6cee3')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_short$FCL, df_short$chain, method='spearman')$estimate, 3)), size=5)

m10=ggplot(df_short, aes(x=omnivory, y=FCL))+ylab('FCL short')+xlab("Omnivory")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#1f78b4')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  ) +xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_short$FCL, df_short$omnivory, method='spearman')$estimate, 3)), size=5)

m11=ggplot(df_short, aes(x=apparent, y=FCL))+ylab('FCL short')+xlab("Apparent")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#b2df8a')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_short$FCL, df_short$apparent, method='spearman')$estimate, 3)), size=5)

m12=ggplot(df_short, aes(x=exploitative, y=FCL))+ylab('FCL short')+xlab("Exploitative")+geom_bin2d()+scale_fill_continuous(low='gray90', high='#33a02c')+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none", panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+xlim(c(0,1.0))+annotate(geom="text", x=0.4, y=9, label=paste0('corr.=', round(cor.test(df_short$FCL, df_short$exploitative, method='spearman')$estimate, 3)), size=5)

r1+r2+r3+m1+m5+m9+m2+m6+m10+m3+m7+m11+m4+m8+m12+plot_layout(nrow = 5, ncol=3)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
ggsave('./Simulations/simulation_pdf/FCL_simulation_correlation.png', width=12, height=16)

```

Next, we analyze how species richness and food web motives affect FCL.
We assume three functional responses: linear, saturating, or quadratic.
We calculate the Akaike Information criterion of 15 models given FCL 
in empirical data set or simulation data.

```{r Model selection in empirical data}
b_start=0.5 # need to tune initial guess so that the algortihm works
AIC_cal2= function(df){
  #-------------Model description------------------------
  model1=nls(formula = FCL + 1 ~ a*Richness, data = df, algorithm='port', 
             lower=c(a=0), upper=c(a=max(df$FCL)+1), start=c(a=1))
  model2=nls(FCL ~ a*(1-exp(-b*Richness))-1, data=df, start=c(a=max(df$FCL)/2, b=b_start),  
             algorithm='port', lower=c(a=0, b=0), upper=c(a=max(df$FCL)+1, b =10)) # saturating func of richness
  model3=nls(FCL ~ -a*Richness^2+b*Richness-1, data=df, start=c(a=1, b=1), 
             algorithm='port', lower=c(a=0, b=0), upper=c(a=10, b=10)) # quadratic func of richness
  model4=nls(formula = FCL + 1 ~ a*Chain, data = df,
             algorithm='port', lower=c(a=0), upper=c(a=max(df$FCL)+1), start=c(a=1))# linear func of chain
  model5=nls(FCL ~ a*(1-exp(-b*Chain))-1, data=df, start=c(a=max(df$FCL)/2, b=b_start),  
             algorithm='port', lower=c(a=0, b=0), upper=c(a=max(df$FCL)+1, b=10)) # saturating func of chain
  model6=nls(FCL ~ -a*Chain^2+b*Chain-1, data=df, start=c(a=1, b=1), 
             algorithm='port', lower=c(a=0, b=0), upper=c(a=10, b=10)) # quadratic func of chain
 
  #combination of chain and richness
  model14=nls(formula = FCL + 1 ~ a*Richness+b*Chain,  lower=c(a=0, b=0), algorithm='port', upper=c(a=max(df$FCL)+1, b=max(df$FCL)+1), 
              start=c(a=1, b=1), data = df)# linear func of chain
  model15=nls(FCL ~ a*Richness+b*(1-exp(-c*Chain))-1, data=df, start=c(a=0.1, b=max(df$FCL)/2, c=b_start), 
              algorithm='port', lower=c(a=0, b=0, c=0), upper=c(a=10, b=max(df$FCL)+1, c=10))
  model16=nls(FCL ~ a*Richness-b*Chain^2+c*Chain-1, data=df, start=c(a=0.1, b=1, c=1), 
              algorithm='port', lower=c(a=0, b=0, c=0), upper=c(a=10, b=10, c=10))
  model24=nls(FCL ~ a*(1-exp(-b*Richness))+c*Chain-1, data=df, start=c(a=max(df$FCL)/2, b=b_start, c=1),
              algorithm='port', lower=c(a=0, b=0, c=0), upper=c(a=max(df$FCL)+1, b=10, c=10))
  model25=nls(FCL ~ a*(1-exp(-b*Richness))+c*(1-exp(-d*Chain))-1, data=df, 
              start=c(a=max(df$FCL)/2, b=b_start, c=max(df$FCL)/2, d=b_start), 
              algorithm='port', lower=c(a=0, b=0, c=0, d=0),
              upper=c(a=max(df$FCL)+1, b=10, c=max(df$FCL)+1, d=10))
  model26=nls(FCL ~ a*(1-exp(-b*Richness))-c*Chain^2+d*Chain-1, data=df, 
              start=c(a=max(df$FCL)/2, b=b_start, c=1, d=1.05), # d= 1 cause a problem of conversence
              algorithm='port', lower=c(a=0, b=0, c=0, d=0), 
              upper=c(a=max(df$FCL)+1, b=10, c=10, d=10))
  model34=nls(FCL ~ -a*Richness^2+b*Richness+c*Chain-1, data=df, start=c(a=1, b=1, c=1),
              algorithm='port', lower=c(a=0, b=0, c=0),
              upper=c(a=10, b=10, c=10))
  model35=nls(FCL ~ -a*Richness^2+b*Richness+c*(1-exp(-d*Chain))-1, data=df, 
              start=c(a=1, b=1, c=max(df$FCL)/2, d=b_start), 
              algorithm='port', lower=c(a=0, b=0, c=0, d=0), 
              upper=c(a=10, b=10, c=max(df$FCL)+1, d=10))
  model36=nls(FCL ~ -a*Richness^2+b*Richness-c*Chain^2+d*Chain-1, data=df, 
              start=c(a=1, b=1, c=1, d=1),
              algorithm='port', lower=c(a=0, b =0, c=0, d=0), 
              upper=c(a=10, b=10, c=10, d=10))
  
  AICs=c(AIC(model1), AIC(model2), AIC(model3), AIC(model4), AIC(model5), AIC(model6),
         AIC(model14),AIC(model15), AIC(model16), AIC(model24), AIC(model25), AIC(model26),
         AIC(model34),AIC(model35), AIC(model36))
  minAIC=min(AICs)
  deltaAIC=AICs-minAIC
  print(AICs)
  
  print(minAIC)
  
  print(deltaAIC)
  
  #print(summary(models[which.max(deltaAIC)]))
}

df_emp$FCL=df_emp$FCL_long
#FCL long
AIC_cal2(na.omit(df_emp)) # we omit FCL na in cyclic food webs
#FCL_mean
df_emp$FCL=df_emp$FCL_mean
AIC_cal2(df_emp)
#FCL short
df_emp$FCL=df_emp$FCL_short
AIC_cal2(df_emp)
```
The best models are saturating + quadriatic (in FCL long) or saturating + linear (in FCL short). However, in the FCL short, using saturating or quadratic functions in chain also seem fine. 
Below, we show the coefficnet values in the best models and plot them.

```{r Best models in mepirical data}
# FCL_long
summary(nls(FCL_long ~ a*(1-exp(-b*Richness))-c*Chain^2+d*Chain-1, data=na.omit(df_emp), 
              start=c(a=max(na.omit(df_emp)$FCL_long)/2, b=b_start, c=1, d=1.05), # d= 1 cause a problem of conversence
              algorithm='port', lower=c(a=0, b=0, c=0, d=0), 
              upper=c(a=max(na.omit(df_emp)$FCL_long)+1, b=10, c=10, d=10)))
#FCL mean
summary(nls(FCL_mean ~ a*(1-exp(-b*Richness))-c*Chain^2+d*Chain-1, data=na.omit(df_emp), 
              start=c(a=max(na.omit(df_emp)$FCL_mean)/2, b=b_start, c=1, d=1.0), 
              algorithm='port', lower=c(a=0, b=0, c=0, d=0), 
              upper=c(a=max(na.omit(df_emp)$FCL_mean)+1, b=10, c=10, d=10)))

# FCL short
summary(nls(FCL_short ~ a*(1-exp(-b*Richness))+c*Chain-1, data=df_emp, start=c(a=max(df_emp$FCL_short)/2, b=b_start, c=1),
              algorithm='port', lower=c(a=0, b=0, c=0), upper=c(a=max(df_emp$FCL_short)+1, b=10, c=10)))
```
```{r Plotting best models with empirical data}
df_emp$predict_short=2.85*(1-exp(-0.19*df_emp$Richness))+2.12*df_emp$Chain-1


g1=ggplot(df_emp, aes(x=Richness, y=FCL_short))+ylab('FCL short')+xlab("Richness")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 2.85*(1-exp(-0.19*x))+2.12*mean(df_emp$Chain)-1, color='green', linewidth=2)

g2=ggplot(df_emp, aes(x=Chain, y=FCL_short))+ylab('FCL short')+xlab("Chain")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 2.85*(1-exp(-0.19*mean(df_emp$Richness)))+2.12*x-1, color='green', linewidth=2)

g3=ggplot(df_emp, aes(x=FCL_short, y=predict_short))+ylim(c(-1, 6))+xlab('FCL short')+ylab("Model prediction")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun=function(x) x, color='blue', linewidth=2)

df_emp$predict_long=3.94*(1-exp(-0.09*df_emp$Richness))-7.3*df_emp$Chain^2+9.45*df_emp$Chain-1

g4=ggplot(df_emp, aes(x=Richness, y=FCL_long))+ylab('FCL long')+xlab("Richness")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 3.94*(1-exp(-0.09*x))-7.3*mean(df_emp$Chain)^2+9.45*mean(df_emp$Chain)-1, color='green', linewidth=2)
g5=ggplot(df_emp, aes(x=Chain, y=FCL_long))+ylab('FCL long')+xlab("Chain")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 3.94*(1-exp(-0.09*mean(df_emp$Richness)))-7.3*x^2+9.45*x-1, color='green', linewidth=2)

g6=ggplot(df_emp, aes(x=FCL_long, y=predict_long))+ylim(c(-1, 6))+xlab('FCL long')+ylab("Model prediction")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun=function(x) x, color='blue', linewidth=2)

df_emp$predict_mean=3.01*(1-exp(-0.14*df_emp$Richness))-2.82*df_emp$Chain^2+4.92*df_emp$Chain-1

g7=ggplot(df_emp, aes(x=Richness, y=FCL_mean))+ylab('FCL mean')+xlab("Richness")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 3.01*(1-exp(-0.14*x))-2.82*mean(df_emp$Chain)^2+4.92*mean(df_emp$Chain)-1, color='green', linewidth=2)

g8=ggplot(df_emp, aes(x=Chain, y=FCL_mean))+ylab('FCL mean')+xlab("Chain")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 3.01*(1-exp(-0.14*mean(df_emp$Richness)))-2.82*x^2+4.92*x-1, color='green', linewidth=2)

g9=ggplot(df_emp, aes(x=FCL_mean, y=predict_mean))+ylim(c(-1, 5))+xlab('FCL mean')+ylab("Model prediction")+geom_point(color = "black", alpha=0.3, size=5)+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun=function(x) x, color='blue', linewidth=2)
g4+g5+g6+g7+g8+g9+g1+g2+g3+plot_layout(nrow = 3)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
ggsave('./empirical_pdf/Modeling_empirical.pdf', width=16, height=8)
```

```{r best models in simulaiton}
#b_start=1.5 # need to tune initial guess so that the algortihm works
AIC_cal1= function(df, b_start=1.5){
    model1=nls(FCL ~ a*richness-1, data=df, start=c(a=1), algorithm='port', 
             lower=c(a=0.01), upper=c(a=10)) # linear func of richness
  model2=nls(FCL ~ a*(1-exp(-b*richness))-1, data=df, start=c(a=max(df$FCL)/2, b=b_start),  
             algorithm='port', lower=c(a=0.01, b=0.01), upper=c(a=max(df$FCL)+1, b =10)) # saturating func of richness
  model3=nls(FCL ~ -a*richness^2+b*richness-1, data=df, start=c(a=1, b=1), 
             algorithm='port', lower=c(a=0.01, b=0.01), upper=c(a=10, b=10)) # quadratic func of richness
  model4=nls(FCL ~ a*chain-1, data=df, start=c(a=1),  
             algorithm='port',lower=c(a=0.01), upper=(a=10)) # linear func of chain
  model5=nls(FCL ~ a*(1-exp(-b*chain))-1, data=df, start=c(a=max(df$FCL)/2, b=b_start),  
             algorithm='port', lower=c(a=0.01, b=0.01), upper=c(a=max(df$FCL)+1, b=10)) # saturating func of chain
  model6=nls(FCL ~ -a*chain^2+b*chain-1, data=df, start=c(a=1, b=1), 
             algorithm='port', lower=c(a=0.01, b=0.01), upper=c(a=10, b=10)) # quadratic func of chain
 
  #combination of chain and richness
  model14=nls(FCL ~ a*richness+b*chain-1, data=df, start=c(a=1, b=1), algorithm='port', 
              lower = c(a=0.01, b=0.01), upper=c(a=10, b=10))
  model15=nls(FCL ~ a*richness+b*(1-exp(-c*chain))-1, data=df, start=c(a=1, b=max(df$FCL)/2, c=b_start), 
              algorithm='port', lower=c(a=0.01, b=0.01, c=0.01), upper=c(a=10, b=max(df$FCL)+1, c=10))
  model16=nls(FCL ~ a*richness-b*chain^2+c*chain-1, data=df, start=c(a=1, b=1, c=1), 
              algorithm='port', lower=c(a=0.01, b=0.01, c=0.01), upper=c(a=10, b=10, c=10))
  model24=nls(FCL ~ a*(1-exp(-b*richness))+c*chain-1, data=df, start=c(a=max(df$FCL)/2, b=b_start, c=1),
              algorithm='port', lower=c(a=0.01, b=0.01, c=0.01), upper=c(a=max(df$FCL)+1, b=10, c=10), 
              control= nls.control(maxiter = 500))
  model25=nls(FCL ~ a*(1-exp(-b*richness))+c*(1-exp(-d*chain))-1, data=df, 
              start=c(a=max(df$FCL)/2, b=b_start, c=max(df$FCL)/2, d=b_start), 
              algorithm='port', lower=c(a=0.01, b=0.01, c=0.01, d=0.01),
              upper=c(a=max(df$FCL)+1, b=10, c=max(df$FCL)+1, d=10),
              control= nls.control(maxiter = 500))
  model26=nls(FCL ~ a*(1-exp(-b*richness))-c*chain^2+d*chain-1, data=df, 
              start=c(a=max(df$FCL)/2, b=b_start, c=1, d=1), 
              algorithm='port', lower=c(a=0.01, b=0.01, c=0.01, d=0.01), 
              upper=c(a=max(df$FCL)+1, b=10, c=10, d=10))
  model34=nls(FCL ~ -a*richness^2+b*richness+c*chain-1, data=df, start=c(a=1, b=1, c=1),
              algorithm='port', lower=c(a=0.01, b=0.01, c=0.01),
              upper=c(a=10, b=10, c=10))
  model35=nls(FCL ~ -a*richness^2+b*richness+c*(1-exp(-d*chain))-1, data=df, 
              start=c(a=1, b=1, c=max(df$FCL)/2, d=b_start), 
              algorithm='port', lower=c(a=0.01, b=0.01, c=0.01, d=0.01), 
              upper=c(a=10, b=10, c=max(df$FCL)+1, d=10))
  model36=nls(FCL ~ -a*richness^2+b*richness-c*chain^2+d*chain-1, data=df, 
              start=c(a=1, b=1, c=1, d=1),
              algorithm='port', lower=c(a=0.01, b =0.01, c=0.01, d=0.01), 
              upper=c(a=10, b=10, c=10, d=10))
  
  AICs=c(AIC(model1), AIC(model2), AIC(model3), AIC(model4), AIC(model5), AIC(model6),
         AIC(model14),AIC(model15), AIC(model16), AIC(model24), AIC(model25), AIC(model26),
         AIC(model34),AIC(model35), AIC(model36))
   minAIC=min(AICs)
  deltaAIC=AICs-minAIC
  print(deltaAIC)
  print(minAIC)
}

#FCL long
AIC_cal1(df_long, 3) 
#FCL mean
AIC_cal1(df_mean, 4)
#FCL short
AIC_cal1(df_short, 1.5) # to avoid bad convergence

```

```{r the best models in simulation data}
model_long=nls(FCL ~ a*(1-exp(-b*richness))-c*chain^2+d*chain-1, data=df_long, 
              start=c(a=max(df_long$FCL)/2, b=3, c=1, d=1), 
              algorithm='port', lower=c(a=0, b=0, c=0, d=0), 
              upper=c(a=max(df_long$FCL)+1, b=10, c=10, d=10))
summary(model_long)

model_mean=nls(FCL ~ a*(1-exp(-b*richness))-c*chain^2+d*chain-1, data=df_mean, 
              start=c(a=max(df_mean$FCL)/2, b=4, c=1, d=1), 
              algorithm='port', lower=c(a=0, b=0, c=0, d=0), 
              upper=c(a=max(df_mean$FCL)+1, b=10, c=10, d=10))
summary(model_mean)

model_short=nls(FCL ~ a*(1-exp(-b*richness))-c*chain^2+d*chain-1, data=df_short, 
              start=c(a=max(df_short$FCL)/2, b=1.5, c=1, d=1), 
              algorithm='port', lower=c(a=0, b=0, c=0, d=0), 
              upper=c(a=max(df_short$FCL)+1, b=10, c=10, d=10))
summary(model_short)

```

```{r best models for simulation data}
# First we fill na with 0s (corresponding richness < 2)

df_long$predict=6.76*(1-exp(-0.08*df_long$richness))-1.58*replace(df_long,is.na(df_long),0)$chain^2+3.13*replace(df_long,is.na(df_long),0)$chain-1 # replace na with 0
g1=ggplot(df_long, aes(x=richness, y=FCL))+ylab('FCL long')+xlab("Richness")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 6.76*(1-exp(-0.08*x))-1.58*mean(df_long$chain, na.rm=TRUE)^2+3.13*mean(df_long$chain, na.rm=TRUE)-1, color='green', linewidth=2)

g2=ggplot(df_long, aes(x=chain, y=FCL))+ylab('FCL long')+xlab("Chain")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 6.76*(1-exp(-0.08*mean(df_long$richness)))-1.58*x^2+3.13*x-1, color='green', linewidth=2)

g3=ggplot(df_long, aes(x=FCL, y=predict))+ylim(c(-1, 6))+xlab('FCL long')+ylab("Model prediction")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun=function(x) x, color='blue', linewidth=2)

# FCL mean 
df_mean$predict=3.78*(1-exp(-0.17*df_mean$richness))-replace(df_mean,is.na(df_mean),0)$chain^2+2.53*replace(df_mean,is.na(df_mean),0)$chain-1
g4=ggplot(df_mean, aes(x=richness, y=FCL))+ylab('FCL mean')+xlab("Richness")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 3.78*(1-exp(-0.17*x))-mean(df_mean$chain, na.rm=TRUE)^2+2.53*mean(df_mean$chain, na.rm=TRUE)-1, color='green', linewidth=2)

g5=ggplot(df_mean, aes(x=chain, y=FCL))+ylab('FCL mean')+xlab("Chain")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 3.78*(1-exp(-0.17*mean(df_mean$richness)))-x^2+2.53*x-1, color='green')
g6=ggplot(df_mean, aes(x=FCL, y=predict))+ylim(c(-1, 6))+xlab('FCL mean')+ylab("Model prediction")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun=function(x) x, color='blue', linewidth=2)

#FCL short
df_short$predict=2.95*(1-exp(-0.25*df_short$richness))-0.6*replace(df_short,is.na(df_short),0)$chain^2+2.02*replace(df_short,is.na(df_short),0)$chain-1
g7=ggplot(df_short, aes(x=richness, y=FCL))+ylab('FCL short')+xlab("Richness")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 2.95*(1-exp(-0.25*x))-0.6*mean(df_short$chain, na.rm=TRUE)^2+2.02*mean(df_short$chain, na.rm=TRUE)-1, color='green', linewidth=2)
g8=ggplot(df_short, aes(x=chain, y=FCL))+ylab('FCL short')+xlab("Chain")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun = function(x) 2.95*(1-exp(-0.25*mean(df_short$richness)))-0.6*x^2+2.02*x-1, color='green', linewidth=2)
g9=ggplot(df_short, aes(x=FCL, y=predict))+ylim(c(-1, 6))+xlab('FCL short')+ylab("Model prediction")+geom_bin2d()+ scale_fill_continuous(low = "gray90", high = "black")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
 legend.text=element_text(size=14),
    legend.title = element_text(size=14)
  )+stat_function(fun=function(x) x, color='blue', linewidth=2)

g1+g2+g3+g4+g5+g6+g7+g8+g9+plot_layout(nrow = 3,)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))

ggsave('./Simulations/simulation_pdf/Modeling_simulations.png', width=12, height=8)

```

Now we show how the three environmental drivers relate to FCL, species richness and the chain motif.
First, we check the relationships between enviornments and FCL

```{r Eviornment vs FCL}
p1=ggplot(df_long, aes(x=factor(resource), y=FCL))+geom_violin(color='#7570b3')+ylab('FCL long')+xlab("Resource")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=2, y=11, label=paste0('corr.=', round(cor.test(df_long$FCL, df_long$resource, method='spearman')$estimate, 3)), size=5)

p2=ggplot(df_long, aes(x=factor(disturbance), y=FCL))+geom_violin(color='#d95f02')+ylab('FCL long')+xlab("Disturbance")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=1.5, y=11, label=paste0('corr.=', round(cor.test(df_long$FCL, df_long$disturbance, method='spearman')$estimate, 3)), size=5)

p3=ggplot(df_long, aes(x=factor(ecosystem), y=FCL))+geom_violin(color='#1b9e77')+ylab('FCL long')+xlab("Ecosystem")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=1.5, y=11, label=paste0('corr.=', round(cor.test(df_long$FCL, df_long$ecosystem, method='spearman')$estimate, 3)), size=5)


p4=ggplot(df_mean, aes(x=factor(resource), y=FCL))+geom_violin(color='#7570b3')+ylab('FCL mean')+xlab("Resource")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=2, y=9, label=paste0('corr.=', round(cor.test(df_mean$FCL, df_mean$resource, method='spearman')$estimate, 3)), size=5)

p5=ggplot(df_mean, aes(x=factor(disturbance), y=FCL))+geom_violin(color='#d95f02')+ylab('FCL mean')+xlab("Disturbance")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=1.5, y=9, label=paste0('corr.=', round(cor.test(df_mean$FCL, df_mean$disturbance, method='spearman')$estimate, 3)), size=5)

p6=ggplot(df_mean, aes(x=factor(ecosystem), y=FCL))+geom_violin(color='#1b9e77')+ylab('FCL mean')+xlab("Ecosystem")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=1.5, y=9, label=paste0('corr.=', round(cor.test(df_mean$FCL, df_mean$ecosystem, method='spearman')$estimate, 3)), size=5)


p7=ggplot(df_short, aes(x=factor(resource), y=FCL))+geom_violin(color='#7570b3')+ylab('FCL short')+xlab("Resource")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=2, y=9, label=paste0('corr.=', round(cor.test(df_short$FCL, df_short$resource, method='spearman')$estimate, 3)), size=5)

p8=ggplot(df_short, aes(x=factor(disturbance), y=FCL))+geom_violin(color='#d95f02')+ylab('FCL short')+xlab("Disturbance")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=1.5, y=9, label=paste0('corr.=', round(cor.test(df_short$FCL, df_short$disturbance, method='spearman')$estimate, 3)), size=5)

p9=ggplot(df_short, aes(x=factor(ecosystem), y=FCL))+geom_violin(color='#1b9e77')+ylab('FCL short')+xlab("Ecosystem")+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+annotate(geom="text", x=1.5, y=9, label=paste0('corr.=', round(cor.test(df_short$FCL, df_short$ecosystem, method='spearman')$estimate, 3)), size=5)

p1+p4+p7+p2+p5+p8+p3+p6+p9+plot_layout(nrow = 3,)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
ggsave('./Simulations/simulation_pdf/FCL_simulation_environemnt.pdf', width=12, height=9)
```
Next we plot richness and chain over the environments.
We plot three figures for each definition of FCL
```{r modulater and enviornments}
PlotCumulative =function(df, fname){
  g1=ggplot(df)+ stat_density(aes(x=richness, linetype=as.factor(resource)), color='#7570b3', geom="line", linewidth=1, position = "identity", adjust=2)
  g1=g1+xlab('Richness')+ylab('Density')  
  g1=g1+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Resource")
  
  
  g2=ggplot(df)+ stat_density(aes(x=richness, linetype=as.factor(disturbance)), color='#d95f02', geom="line", linewidth=1, position='identity', adjust=2)
  g2=g2+xlab('Richness')+ylab('Density')  
  g2=g2+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Disturbance")
  
  g3=ggplot(df)+ stat_density(aes(richness, linetype=factor(ecosystem)), color='#1b9e77', geom="line", linewidth=1,position='identity', adjust=2)
  g3=g3+xlab('Richness')+ylab('Density')  
  g3=g3+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Ecosystem")
  
  g4=ggplot(df)+ stat_density(aes(chain, linetype=factor(resource)), color='#7570b3', geom="line", linewidth=1, position="identity", adjust=2)
  g4=g4+xlab('Chain')+ylab('Density')  
  g4=g4+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Resource")
  
  
  g5=ggplot(df)+ stat_density(aes(chain, linetype=factor(disturbance)), color='#d95f02', geom="line", linewidth=1, position="identity", adjust=2)
  g5=g5+xlab('Chain')+ylab('Density')  
  g5=g5+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Disturbance")
  
  g6=ggplot(df)+ stat_density( aes(chain, linetype=factor(ecosystem)), color='#1b9e77', geom='line', linewidth=1, position="identity", adjust=2)
  g6=g6+xlab('Chain')+ylab('Density')  
  g6=g6+xlim(c(0, 1))+ylim(c(0,7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Ecosystem")
  
  g1+g4+g2+g5+g3+g6+plot_layout(nrow = 3,)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
  ggsave(paste0('./Simulations/simulation_pdf/', fname), heigh=12, width=12)
}
PlotCumulative(df_long,'Cumulative_richness_chain_FCLlong.pdf')
PlotCumulative(df_mean,'Cumulative_richness_chain_FCLmean.pdf')
PlotCumulative(df_short,'Cumulative_richness_chain_FCLshort.pdf')
```



```{r alternative above}
x=seq(0,32)
reg_mean=data.frame(richness=x, FCL=3.81*(1-exp(-0.17*x))-0.91*mean(df_mean$chain, na.rm=TRUE)^2+2.43*mean(df_mean$chain, na.rm=TRUE)-1)

grad_by_val <- function(x, y, cols = blues9) {
  require(grid)
  y <- y[order(x)]
  ys <- (y - min(y)) / diff(range(y))
  cols <- colorRamp(cols)(ys) / 256
  colnames(cols) <- c("red", "green", "blue")
  cols <- apply(cols, 1, function(z) do.call(rgb, as.list(z)))
  mat <- matrix(cols, ncol = length(x))
  rasterGrob(
    image = mat,
    width = unit(1, "npc"),
    height = unit(1, "npc"),
    interpolate = TRUE
  )
}
g1=ggplot(df_mean, aes(richness, linetype=factor(disturbance), color=factor(ecosystem)))+ annotation_custom(grob = grad_by_val(reg_mean$richness, reg_mean$FCL),xmin = -Inf,xmax = Inf,ymin = -Inf,ymax = Inf)+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g1=g1+xlab('Richness')+ylab('Density')  
g1=g1+xlim(c(0, 32))+ylim(c(0, 0.25))+theme(
     axis.text.x = element_text(size=14),
     axis.title.x = element_text(size=20),
     axis.text.y = element_text(size=14),
     axis.title.y = element_text(size=20))+labs(linetype = "Disturbance", color='Ecosystem')

g2=g2+xlim(c(0, 32))+ylim(c(0, 0.25))+theme(
     axis.text.x = element_text(size=14),
     axis.title.x = element_text(size=20),
     axis.text.y = element_text(size=14),
     axis.title.y = element_text(size=20))+labs(linetype = "Disturbance")
```

```{r heatmap of FCL and compare how richness change over dist and eco size}
library(plotrix)
library(quantreg)
Heatmap_generator=function(df, gname1=FALSE, gname2=FALSE){
  # data processing
  ecosystem=unique(df$ecosystem)
  disturbance=unique(df$disturbance)
  data=expand.grid(Ecosystem=unique(df$ecosystem),
                Disturbance=unique(df$disturbance))
  median_FCL=c()
  median_richness=c()
  for (i in 1:nrow(data)){
    sub_df=subset(df, ecosystem==data$Ecosystem[i] & disturbance==data$Disturbance[i])
    median_FCL=c(median_FCL, median(sub_df$FCL))
    median_richness=c(median_richness, median(sub_df$richness))
  }
 
  data$FCL=median_FCL
  data$Richness=median_richness
  
  # plot heatamap
  g=ggplot(data, aes(Ecosystem, Disturbance, fill= FCL), fig(8,8)) + 
    xlab('Ecosystem size')+ylab("Disturbance")+
    geom_tile(color = "black") +scale_y_continuous(breaks=seq(0.2,0.8,by=0.2))+
    scale_fill_gradient(low="white", high="blue", name="FCL") +
     coord_fixed(ratio=2.5)+theme_bw()+
    theme(
     axis.text.x = element_text(size=14),
     axis.title.x = element_text(size=20),
     axis.text.y = element_text(size=14),
     axis.title.y = element_text(size=20),
     panel.grid = element_blank(),
     legend.title = element_text(size=20),
     legend.text = element_text(size=14))+
    guides(fill = guide_colourbar(barwidth =1,
                                barheight = 20))+
    geom_rect(aes(xmin = 0.375, xmax =0.625 , ymin = 0.05, ymax = 0.35), 
             color = "gray", alpha=0, size=1.5)+
    geom_rect(aes(xmin = 1.875, xmax =2.125 , ymin = 0.05, ymax = 0.35), 
             color = "gray", alpha=0, size=1.5)+
    geom_rect(aes(xmin = 1.375, xmax =2.125 , ymin = 0.05, ymax = 0.15), 
             color = "gray", alpha=0, size=1.5, linetype='dashed')+
    geom_rect(aes(xmin = 1.375, xmax =2.125 , ymin = 0.75, ymax = 0.85), 
             color = "gray", alpha=0, size=1.5, linetype='dashed')+
   geom_curve(aes(xend = 0.5, yend = 0.35, x = 2.0, y = 0.35),
         size=1.5,arrow = arrow(length = unit(0.07, "npc"), ends="both"))+
   geom_curve(aes(xend = 1.375, yend = 0.1, x = 1.375, y = 0.8),
             data = data, size=1.5,
             arrow = arrow(length = unit(0.07, "npc"), ends="both"))
    #quantile regression
 
  # plot some distributions of  FCL over emvironments
  d_sub=subset(df,disturbance <0.4)
  
  d_dist1=subset(d_sub, ecosystem==0.5)
  d_dist2=subset(d_sub,  ecosystem==2)
  d_dist=rbind(d_dist1, d_dist2)
  
  print(summary(rq(FCL ~ disturbance, data = d_dist1, tau=0.5)))
  print(summary(rq(FCL ~ disturbance, data = d_dist2, tau=0.5)))
  
  g1=ggplot(d_dist, aes(x=disturbance, y=FCL, color=factor(ecosystem), fill=factor(ecosystem)))+
  stat_summary(geom="ribbon", fun.ymin = function(x) quantile(x, 0.25), fun.ymax = function(x) quantile(x, 0.75), alpha=0.3)+stat_summary(geom="point", fun=median, size=7) +stat_summary(geom="line", fun=median, linewidth=2)+
    #geom_violin(draw_quantiles = c(0.5))+
  ylab('FCL')+xlab("Disturbance")+
  ylim(c(-1, max(df$FCL)))+
  scale_x_continuous(breaks=seq(0.1,0.3,by=0.1))+
  theme_bw()+theme(
  axis.text.x = element_text(size=13),
  axis.title.x = element_text(size=18),
   axis.text.y = element_text(size=13),
  axis.title.y = element_text(size=18),
panel.grid = element_blank(),
legend.position = "none")+
  guides(color=guide_legend(title="Ecosystem size"))
  
   g2=ggplot(d_dist, aes(x=disturbance, y=richness, color=factor(ecosystem), fill=factor(ecosystem)))+
  #geom_violin(draw_quantiles = c(0.5))+
     stat_summary(geom="ribbon", fun.ymin = function(x) quantile(x, 0.25), fun.ymax = function(x) quantile(x, 0.75), alpha=0.3)+stat_summary(geom="point", fun=median, size=7) +stat_summary(geom="line", fun=median, linewidth=2)+
     ylab('Richness')+xlab("Disturbance")+
  ylim(c(0, 32))+
  scale_x_continuous(breaks=seq(0.1,0.3,by=0.1))+
  theme_bw()+theme(
  axis.text.x = element_text(size=13),
  axis.title.x = element_text(size=18),
   axis.text.y = element_text(size=13),
  axis.title.y = element_text(size=18),
panel.grid = element_blank(),
legend.title = element_text(size=18),
legend.text = element_text(size=13))+
  guides(color=guide_legend(title="Ecosystem size"), fill=FALSE)
  
  
  d_sub=subset(df,ecosystem >1.25)
  
  d_eco1=subset(d_sub, disturbance==0.1)
  d_eco2=subset(d_sub,  disturbance==0.8)
  d_eco=rbind(d_eco1, d_eco2)
  
  print(summary(rq(FCL ~ ecosystem, data = d_eco1, tau=0.5)))
  print(summary(rq(FCL ~ ecosystem, data = d_eco2, tau=0.5)))
  
  g3=ggplot(d_eco, aes(x=ecosystem, y=FCL, color=factor(disturbance), fill=factor(disturbance)))+
  stat_summary(geom="ribbon", fun.ymin = function(x) quantile(x, 0.25), fun.ymax = function(x) quantile(x, 0.75), alpha=0.3)+stat_summary(geom="point", fun=median, size=7) +stat_summary(geom="line", fun=median, linewidth=2)+
    #geom_violin(draw_quantiles = c(0.5))
  ylab('FCL')+xlab("Ecosystem size")+
  ylim(c(-1, max(df$FCL)))+
    scale_x_continuous(breaks=seq(1.5,2,by=0.25))+
  theme_bw()+theme(
  axis.text.x = element_text(size=13),
  axis.title.x = element_text(size=18),
   axis.text.y = element_text(size=13),
  axis.title.y = element_text(size=18),
panel.grid = element_blank(),
legend.position="none")+
  guides(color=guide_legend(title="Disturbance"), )
  
   g4=ggplot(d_eco, aes(x=ecosystem, y=richness, color=factor(disturbance),fill=factor(disturbance)))+
     stat_summary(geom="ribbon", fun.ymin = function(x) quantile(x, 0.25), fun.ymax = function(x) quantile(x, 0.75), alpha=0.3)+stat_summary(geom="point", fun=median, size=7) +stat_summary(geom="line", fun=median, linewidth=2)+
     #geom_violin(draw_quantiles = c(0.5))+
     ylab('Richness')+xlab("Ecosystem size")+
  ylim(c(0, 32))+
      scale_x_continuous(breaks=seq(1.5,2,by=0.25))+
  theme_bw()+theme(
  axis.text.x = element_text(size=13),
  axis.title.x = element_text(size=18),
   axis.text.y = element_text(size=13),
  axis.title.y = element_text(size=18),
panel.grid = element_blank(),
legend.title = element_text(size=18),
legend.text = element_text(size=13))+
  guides(color=guide_legend(title="Disturbance"), fill=FALSE)
   
  
   if(gname1 !=FALSE){
      G= g|(g1|g2)/(g3|g4)
   G=G+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
     ggsave(paste0('./Simulations/simulation_pdf/', gname1), heigh=8, width=16)
   }
   
   if(gname2 !=FALSE){
     p=ggplot(data, aes(Ecosystem, Disturbance, fill= Richness), fig(8,8)) + 
    xlab('Ecosystem size')+ylab("Disturbance")+
    geom_tile(color = "black") +scale_y_continuous(breaks=seq(0.2,0.8,by=0.2))+
    scale_fill_gradient(breaks = seq(0, 32, by=5), low="white", high="blue", name="Richness") +geom_text(aes(label = round(Richness, 1)))+
     coord_fixed(ratio=2.5)+theme_bw()+
    theme(
     axis.text.x = element_text(size=14),
     axis.title.x = element_text(size=20),
     axis.text.y = element_text(size=14),
     axis.title.y = element_text(size=20),
     panel.grid = element_blank(),
     legend.title = element_text(size=20),
     legend.text = element_text(size=14))+
    guides(fill = guide_colourbar(barwidth =1,
                                barheight = 20))
     ggsave(paste0('./Simulations/simulation_pdf/', gname2), heigh=8, width=8)
     
     
     # test
     G=(g/p)|(g1|g2)/(g3|g4)
     G=G+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
     ggsave(paste0('./Simulations/simulation_pdf/', "all_summary_heatmap.pdf"), heigh=10, width=16)
   }
  
}
Heatmap_generator(df_mean, 'FCLmean_heatmap.pdf', 'FCLmean_Richness_heatmap.pdf')

```
We also show heatmaps of FCL long and FCL short
```{r other heat maps}
Heatmap_generator2=function(df1, df2, gname){
  # data processing
  ecosystem=unique(df$ecosystem)
  disturbance=unique(df$disturbance)
  data1=expand.grid(Ecosystem=unique(df1$ecosystem),
                Disturbance=unique(df1$disturbance))
  data2=expand.grid(Ecosystem=unique(df2$ecosystem),
                Disturbance=unique(df2$disturbance))
  median_FCL1=c()
  median_richness1=c()
  median_FCL2=c()
  median_richness2=c()
  for (i in 1:nrow(data)){
    sub_df1=subset(df1, ecosystem==data1$Ecosystem[i] &disturbance==data1$Disturbance[i])
    median_FCL1=c(median_FCL1, median(sub_df1$FCL))
    median_richness1=c(median_richness1, median(sub_df1$richness))
   sub_df2=subset(df2, ecosystem==data2$Ecosystem[i] &disturbance==data2$Disturbance[i])
    median_FCL2=c(median_FCL2, median(sub_df2$FCL))
    median_richness2=c(median_richness2, median(sub_df2$richness))
    
  }
 
  data1$FCL=median_FCL1
  data1$Richness=median_richness1
  data2$FCL=median_FCL2
  data2$Richness=median_richness2
  
  # plot heatamap
  g1=ggplot(data1, aes(Ecosystem, Disturbance, fill= FCL), fig(8,8)) + 
    xlab('Ecosystem size')+ylab("Disturbance")+
    geom_tile(color = "black") +scale_y_continuous(breaks=seq(0.2,0.8,by=0.2))+
    scale_fill_gradient(low="white", high="blue", name="FCL") +
     coord_fixed(ratio=2.5)+theme_bw()+
    theme(
     axis.text.x = element_text(size=14),
     axis.title.x = element_text(size=20),
     axis.text.y = element_text(size=14),
     axis.title.y = element_text(size=20),
     panel.grid = element_blank(),
     legend.title = element_text(size=20),
     legend.text = element_text(size=14))+
    guides(fill = guide_colourbar(barwidth =1,
                                barheight = 20))
  g2=ggplot(data2, aes(Ecosystem, Disturbance, fill= FCL), fig(8,8)) + 
    xlab('Ecosystem size')+ylab("Disturbance")+
    geom_tile(color = "black") +scale_y_continuous(breaks=seq(0.2,0.8,by=0.2))+
    scale_fill_gradient(low="white", high="blue", name="FCL") +
     coord_fixed(ratio=2.5)+theme_bw()+
    theme(
     axis.text.x = element_text(size=14),
     axis.title.x = element_text(size=20),
     axis.text.y = element_text(size=14),
     axis.title.y = element_text(size=20),
     panel.grid = element_blank(),
     legend.title = element_text(size=20),
     legend.text = element_text(size=14))+
    guides(fill = guide_colourbar(barwidth =1,
                                barheight = 20))
  
  g3=ggplot(data1, aes(Ecosystem, Disturbance, fill= Richness), fig(8,8)) + 
    xlab('Ecosystem size')+ylab("Disturbance")+
    geom_tile(color = "black") +scale_y_continuous(breaks=seq(0.2,0.8,by=0.2))+
    scale_fill_gradient(breaks = seq(0, 32, by=5), low="white", high="blue", name="Richness") +geom_text(aes(label = round(Richness, 1)))+
     coord_fixed(ratio=2.5)+theme_bw()+
    theme(
     axis.text.x = element_text(size=14),
     axis.title.x = element_text(size=20),
     axis.text.y = element_text(size=14),
     axis.title.y = element_text(size=20),
     panel.grid = element_blank(),
     legend.title = element_text(size=20),
     legend.text = element_text(size=14))+
    guides(fill = guide_colourbar(barwidth =1,
                                barheight = 20))
  
  g4=ggplot(data2, aes(Ecosystem, Disturbance, fill= Richness), fig(8,8)) + 
    xlab('Ecosystem size')+ylab("Disturbance")+
    geom_tile(color = "black") +scale_y_continuous(breaks=seq(0.2,0.8,by=0.2))+
    scale_fill_gradient(breaks = seq(0, 32, by=5), low="white", high="blue", name="Richness") +geom_text(aes(label = round(Richness, 1)))+
     coord_fixed(ratio=2.5)+theme_bw()+
    theme(
     axis.text.x = element_text(size=14),
     axis.title.x = element_text(size=20),
     axis.text.y = element_text(size=14),
     axis.title.y = element_text(size=20),
     panel.grid = element_blank(),
     legend.title = element_text(size=20),
     legend.text = element_text(size=14))+
    guides(fill = guide_colourbar(barwidth =1,
                                barheight = 20))
  G=(g1|g2)/(g3|g4)
  G=G+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
  ggsave(paste0('./Simulations/simulation_pdf/', gname), heigh=12, width=12)
  
}
Heatmap_generator2(df_long, df_short, 'FCLlong-short_heatmap.pdf')
```


Below, we plot some additional data.
First, we categorized the ecosystems from the empirical data base.
```{r Ecosystem categories in empirical data}
library(plyr)
df_new=df_emp
C=count(df_emp, 'Ecosystems')
print(C)
# remove categories <=3
remove=C[,2]<=3
remove_category=c()
for (i in 1:length(remove)){
  if(remove[i]==TRUE){
   df_new$Ecosystem[df_new$Ecosystem==C[i,1]]='others' 
  }
}

g1=ggplot(df_new, aes(x=Ecosystem, fill=Ecosystem)) + geom_bar()+ylab('Count')+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )
#ggsave("Cohen_Ecosystem_count.pdf")

# calclulate richness and FCLs in each ecosystem
g2=ggplot(data=df_new, aes(x=Ecosystem, y=Richness, color=Ecosystem)) +geom_jitter(position=position_jitter(0.2))+ylab('Richness')+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )
#ggsave("Cohen_Ecosystem_richness.pdf")


#ggplot(data=df_new, aes(x=Ecosystem, y=FCL_long, color=Ecosystem)) +geom_jitter(position=position_jitter(0.2))+ylab('FCL long')+theme(
g3=ggplot(df_new, aes(x=Ecosystem, y=FCL_long, color=Ecosystem)) + ylab('FCL long' )+
  geom_count(aes(size=..prop.., group=Ecosystem))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )
#ggsave("Cohen_Ecosystem_long.pdf")

g4=ggplot(df_new, aes(x=Ecosystem, y=FCL_mean, color=Ecosystem)) + ylab('FCL mean')+
  geom_count(aes(size=..prop.., group=Ecosystem))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+guides(color = 'none')

#ggplot(data=df_new, aes(x=Ecosystem, y=FCL_short, color=Ecosystem)) +geom_jitter(position=position_jitter(0.2))+ylab('FCL short')+theme(
g5=ggplot(df_new, aes(x=Ecosystem, y=FCL_short, color=Ecosystem)) + ylab('FCL short')+
  geom_count(aes(size=..prop.., group=Ecosystem))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
panel.grid = element_blank(),
  )+guides(color = 'none')
#ggsave("Cohen_Ecosystem_short.pdf")
g1+g2+plot_spacer()+g3+g4+g5+plot_layout(nrow = 2, ncol=3)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
ggsave('./empirical_pdf/Empirical_SI.pdf', heigh=12, width=16)
```
Next, we plot the cumulative probabilities over the two environmental factors
```{r resource and disturbance}
g1=ggplot(df_long, aes(richness, linetype=factor(resource), color=factor(disturbance)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g1=g1+xlab('Richness')+ylab('Density')  
g1=g1+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Disturbance')


g2=ggplot(df_mean, aes(richness, linetype=factor(resource), color=factor(disturbance)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g2=g2+xlab('Richness')+ylab('Density')  
g2=g2+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Disturbance')


g3=ggplot(df_short, aes(richness, linetype=factor(resource), color=factor(disturbance)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g3=g3+xlab('Richness')+ylab('Density')  
g3=g3+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Disturbance')

g4=ggplot(df_long, aes(chain, linetype=factor(resource), color=factor(disturbance)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g4=g4+xlab('Chain')+ylab('Density')  
g4=g4+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Disturbance')


g5=ggplot(df_mean, aes(chain, linetype=factor(resource), color=factor(disturbance)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g5=g5+xlab('Chain')+ylab('Density')  
g5=g5+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Disturbance')

g6=ggplot(df_short, aes(chain, linetype=factor(resource), color=factor(disturbance)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g6=g6+xlab('Chain')+ylab('Density')  
g6=g6+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Disturbance')

g1+g4+g2+g5+g3+g6+plot_layout(nrow = 3,)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
ggsave('./Simulations/simulation_pdf/Cumulative_Richness_Chain_ver1.pdf', heigh=12, width=12)

```

```{r resource and ecosystem}
g1=ggplot(df_long, aes(richness, linetype=factor(resource), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g1=g1+xlab('Richness')+ylab('Density')  
g1=g1+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Ecosystem')

g2=ggplot(df_mean, aes(richness, linetype=factor(resource), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g2=g2+xlab('Richness')+ylab('Density')  
g2=g2+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Ecosystem')


g3=ggplot(df_short, aes(richness, linetype=factor(resource), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g3=g3+xlab('Richness')+ylab('Density')  
g3=g3+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Ecosystem')

g4=ggplot(df_long, aes(chain, linetype=factor(resource), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g4=g4+xlab('Chain')+ylab('Density')  
g4=g4+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Ecosystem')


g5=ggplot(df_mean, aes(chain, linetype=factor(resource), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g5=g5+xlab('Chain')+ylab('Density')  
g5=g5+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Ecosystem')

g6=ggplot(df_short, aes(chain, linetype=factor(resource), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g6=g6+xlab('Chain')+ylab('Density')  
g6=g6+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
panel.grid = element_blank(),
  )+labs(linetype = "Resource", color='Ecosystem')

g1+g4+g2+g5+g3+g6+plot_layout(nrow = 3,)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
ggsave('./Simulations/simulation_pdf/Cumulative_Richness_Chain_ver2.pdf', heigh=12, width=12)

```

```{r disturbance and ecosystem}
g1=ggplot(df_long, aes(richness, linetype=factor(disturbance), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g1=g1+xlab('Richness')+ylab('Density')  
g1=g1+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Disturbance", color='Ecosystem')


g2=ggplot(df_mean, aes(richness, linetype=factor(disturbance), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g2=g2+xlab('Richness')+ylab('Density')  
g2=g2+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Disturbance", color='Ecosystem')


g3=ggplot(df_short, aes(richness, linetype=factor(disturbance), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g3=g3+xlab('Richness')+ylab('Density')  
g3=g3+xlim(c(0, 32))+ylim(c(0, 0.25))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Disturbance", color='Ecosystem')

g4=ggplot(df_long, aes(chain, linetype=factor(disturbance), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g4=g4+xlab('Chain')+ylab('Density')  
g4=g4+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
panel.grid = element_blank(),
  )+labs(linetype = "Disturbance", color='Ecosystem')


g5=ggplot(df_mean, aes(chain, linetype=factor(disturbance), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g5=g5+xlab('Chain')+ylab('Density')  
g5=g5+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Disturbance", color='Ecosystem')

g6=ggplot(df_mean, aes(chain, linetype=factor(disturbance), color=factor(ecosystem)))+ stat_density(geom="line", linewidth=1, position='identity', adjust=2)
g6=g6+xlab('Chain')+ylab('Density')  
g6=g6+xlim(c(0, 1))+ylim(c(0, 7))+
  theme_bw()+theme(
axis.text.x = element_text(size=14),
  axis.title.x = element_text(size=20),
   axis.text.y = element_text(size=14),
  axis.title.y = element_text(size=20),
  legend.position="none",
panel.grid = element_blank(),
  )+labs(linetype = "Disturbance", color='Ecosystem')

g1+g4+g2+g5+g3+g6+plot_layout(nrow = 3,)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
ggsave('./Simulations/simulation_pdf/Cumulative_Richness_Chain_ver3.pdf', heigh=12, width=12)

```
```{r correlation heat map}
library(tidyverse)
library(igraph)
library(Matrix)
library(ggplot2)
library(patchwork)
library(ggcorrplot)
df_emp=read.csv("Cohen2010_summary.csv") # empirical data
df_long=read.csv("./Simulations/FCL_long_simulations_summary.csv") # simulation using FCL long
df_mean=read.csv("./Simulations/FCL_mean_simulations_summary.csv") # simulation using FCL mean
df_short=read.csv("./Simulations/FCL_short_simulations_summary.csv") # simulation using FCL short
# Preparing data analysis
# For df_emp, we removed unnecessary columns and convert the count data of motives into fractions
df_emp = subset(df_emp, select = -c(empty,monoA.single, bi.single) )
df_emp=df_emp %>% select(order(colnames(df_emp)))
df_emp=dplyr::select(df_emp, WEB_id,Ecosystem, FCL_long,FCL_mean, FCL_short,richness,Ecosystem, everything())
sum.motif=apply(df_emp[, 7:ncol(df_emp)], 1, sum) # sum of motives in each row
df_emp[, 7:ncol(df_emp)] = df_emp[, 7:ncol(df_emp)]/sum.motif # converting into fractions of motives
# we remove motives that do not  or rarely appear
df_emp = subset(df_emp, select = -c(WEB_id, d1, d2,d3, d4, s3, d5, d6, d7,d8) )
colnames(df_emp) = c('Ecosystems', 'FCL_long', 'FCL_mean', 'FCL_short', 'Richness', 
                     'Chain', 'Omnivory', 'Apparent', 'Exploitative')
df_long=df_long[, c(2:4,6:ncol(df_long))]
colnames(df_long)=c('Resource', 'Disturbance',  'Ecosystem',  'FCL',
                    'Chain',  'Omnivory',  'Apparent', 'Exploitative',  'Richness')
df_long=df_long[, c('Resource', 'Disturbance',  'Ecosystem',  'FCL','Richness',
                    'Chain',  'Omnivory',  'Apparent', 'Exploitative' )]
df_mean=df_mean[, c(2:4, 6:ncol(df_mean))]
colnames(df_mean)=c('Resource', 'Disturbance',  'Ecosystem',  'FCL','Richness',
                    'Chain',  'Omnivory',  'Apparent', 'Exploitative' )
df_short=df_short[, c(2:4, 6:ncol(df_short))]
colnames(df_short)=c('Resource', 'Disturbance',  'Ecosystem',  'FCL','Richness',
                    'Chain', 'Omnivory',  'Apparent', 'Exploitative' )
corr1=cor(df_emp[, 2:ncol(df_emp)], use = "pairwise.complete.obs", method='spearman') # pearson and spearman show similar results
g1=ggcorrplot(corr1, type = "lower", lab = TRUE)
corr2=cor(df_long, use = "pairwise.complete.obs", method='spearman') # pearson and spearman show similar results
g2=ggcorrplot(corr2, type = "lower", lab = TRUE)
corr3=cor(df_mean, use = "pairwise.complete.obs", method='spearman') # pearson and spearman show similar results
g3=ggcorrplot(corr3, type = "lower", lab = TRUE)
corr4=cor(df_short, use = "pairwise.complete.obs", method='spearman') # pearson and spearman show similar results
g4=ggcorrplot(corr4, type = "lower", lab = TRUE)
g=g1+g2+g3+g4+plot_layout(nrow = 2)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
ggsave('./HeatMapCorrelation.pdf', heigh=12, width=12)
```
```{r Fraction of motifs over richness}
Motif_frac_dist=function(target_motif, richness, connectance=0.11){
  # target motif
  # 1: chain
  # 2: omnivory
  # 3: apparent competition
  # 4: exploitative competition
  p=connectance
  q=1-connectance
    
  sum_non_motif=q**6 + 6*p*q**5 + 3*p**2*q**4 # sum of isolation, uni-single, or bi-single
  if(target_motif==1){
    # target is chain motif
    frac_target=(6*p**2*q**4)/(1-sum_non_motif)
  }else if (target_motif==2){
    #target is omnivory motif
    frac_target=(6*p**3*q**3)/(1-sum_non_motif)
  }else{
    # target is apparent or exploitative competition
    frac_target=(3*p**2*q**4)/(1-sum_non_motif)
  }
  num_motif=richness*(richness-1)*(richness-2)/6*(1-sum_non_motif)
  
  mean_frac=frac_target
  std_frac=sqrt(frac_target*(1-frac_target)/num_motif)
  return(data.frame(Richness=richness, 
                    Mean=rep(mean_frac, length(richness)),
                    SD=std_frac))
  
}
```

```{r Scatter plot motifs vs richness}
Scatter=function(data, gname, alpha=1){

  # Get distributions in the null model 
  stat_null=Motif_frac_dist(1, seq(3, max(data$Richness)))
  stat_null$Up=pmin(stat_null$Mean+2*stat_null$SD, 1)
  stat_null$Low=pmax(stat_null$Mean-2*stat_null$SD, 0)
  g1=ggplot(data, aes(x=Richness))+geom_bin2d(aes(y=Chain))+scale_fill_continuous(low='gray90',high='#a6cee3')
  g1=g1+geom_line(data=stat_null, aes(x=Richness, y=Up), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Low), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Mean), color='black', linetype='dashed')+ylim(0,1)
  g1=g1+ theme_bw()+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20), 
    panel.grid = element_blank(),
    legend.text=element_text(size=14),
    legend.title = element_text(size=14)
    )
  
  stat_null=Motif_frac_dist(2, seq(3, max(data$Richness)))
  stat_null$Up=pmin(stat_null$Mean+2*stat_null$SD, 1)
  stat_null$Low=pmax(stat_null$Mean-2*stat_null$SD, 0)
  g2=ggplot(data, aes(x=Richness))+geom_bin2d(aes(y=Omnivory))+scale_fill_continuous(low='gray90',high='#1f78b4')
  g2=g2+geom_line(data=stat_null, aes(x=Richness, y=Up), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Low), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Mean), color='black', linetype='dashed')+ylim(0,1)
  g2=g2+ theme_bw()+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20),
    panel.grid = element_blank(),
     legend.text=element_text(size=14),
    legend.title = element_text(size=14))
 
  stat_null=Motif_frac_dist(3, seq(3, max(data$Richness)))
  stat_null$Up=pmin(stat_null$Mean+2*stat_null$SD, 1)
  stat_null$Low=pmax(stat_null$Mean-2*stat_null$SD, 0)
  g3=ggplot(data, aes(x=Richness))+geom_bin2d(aes(y=Apparent))+scale_fill_continuous(low='gray90',high='#b2df8a')
  g3=g3+geom_line(data=stat_null, aes(x=Richness, y=Up), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Low), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Mean), color='black', linetype='dashed')+ylim(0,1)
  g3=g3+ theme_bw()+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20), 
    panel.grid = element_blank(),
     legend.text=element_text(size=14),
    legend.title = element_text(size=14))
  
stat_null=Motif_frac_dist(3, seq(3, max(data$Richness)))
  stat_null$Up=pmin(stat_null$Mean+2*stat_null$SD, 1)
  stat_null$Low=pmax(stat_null$Mean-2*stat_null$SD, 0)
  g4=ggplot(data, aes(x=Richness))+geom_bin2d(aes(y=Exploitative))+scale_fill_continuous(low='gray90',high='#33a02c')
  g4=g4+geom_line(data=stat_null, aes(x=Richness, y=Up), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Low), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Mean), color='black', linetype='dashed')+ylim(0,1)
  g4=g4+ theme_bw()+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20),
    panel.grid = element_blank(),
     legend.text=element_text(size=14),
    legend.title = element_text(size=14))
  g=g1+g2+g3+g4+plot_layout(nrow = 2)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
  ggsave(paste0('ScatterCorr_', gname, '.png'), heigh=12, width=12)
}
```




```{r scatter for simulation}
Scatter_sim=function(data, gname, alpha=1){

  # Get distributions in the null model 
  stat_null=Motif_frac_dist(1, seq(3, 32))
  stat_null$Up=pmin(stat_null$Mean+2*stat_null$SD, 1)
  stat_null$Low=pmax(stat_null$Mean-2*stat_null$SD, 0)
  g1=ggplot(data, aes(x=richness))+geom_bin2d(aes(y=chain))+scale_fill_continuous(low='gray90',high='#a6cee3')
  g1=g1+geom_line(data=stat_null, aes(x=Richness, y=Up), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Low), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Mean), color='black', linetype='dashed')+ylim(0,1)
  g1=g1+ theme_bw()+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20), 
    panel.grid = element_blank(),
    legend.text=element_text(size=14),
    legend.title = element_text(size=14)
    )

  stat_null=Motif_frac_dist(2, seq(3, 32))
  stat_null$Up=pmin(stat_null$Mean+2*stat_null$SD, 1)
  stat_null$Low=pmax(stat_null$Mean-2*stat_null$SD, 0)
  g2=ggplot(data, aes(x=richness))+geom_bin2d(aes(y=omnivory))+scale_fill_continuous(low='gray90',high='#1f78b4')
  g2=g2+geom_line(data=stat_null, aes(x=Richness, y=Up), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Low), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Mean), color='black', linetype='dashed')+ylim(0,1)
  g2=g2+ theme_bw()+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20),
    panel.grid = element_blank(),
     legend.text=element_text(size=14),
    legend.title = element_text(size=14))
 
  stat_null=Motif_frac_dist(3, seq(3, 32))
  stat_null$Up=pmin(stat_null$Mean+2*stat_null$SD, 1)
  stat_null$Low=pmax(stat_null$Mean-2*stat_null$SD, 0)
  g3=ggplot(data, aes(x=richness))+geom_bin2d(aes(y=apparent))+scale_fill_continuous(low='gray90',high='#b2df8a')
  g3=g3+geom_line(data=stat_null, aes(x=Richness, y=Up), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Low), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Mean), color='black', linetype='dashed')+ylim(0,1)
  g3=g3+ theme_bw()+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20), 
    panel.grid = element_blank(),
     legend.text=element_text(size=14),
    legend.title = element_text(size=14))
  
 stat_null=Motif_frac_dist(3, seq(3, 32))
  stat_null$Up=pmin(stat_null$Mean+2*stat_null$SD, 1)
  stat_null$Low=pmax(stat_null$Mean-2*stat_null$SD, 0)
  g4=ggplot(data, aes(x=richness))+geom_bin2d(aes(y=exploitative))+scale_fill_continuous(low='gray90',high='#33a02c')
  g4=g4+geom_line(data=stat_null, aes(x=Richness, y=Up), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Low), color='black')+geom_line(data=stat_null, aes(x=Richness, y=Mean), color='black', linetype='dashed')+ylim(0,1)
  g4=g4+ theme_bw()+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20),
    panel.grid = element_blank(),
     legend.text=element_text(size=14),
    legend.title = element_text(size=14))
  g=g1+g2+g3+g4+plot_layout(nrow = 2)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
  ggsave(paste0('./Simulations/simulation_pdf/ScatterCorr_Simulation_', gname, '.png'), heigh=12, width=12)
}
Scatter_sim(df_long, "FCLlong")

Scatter_sim(df_mean, "FCLmean")

Scatter_sim(df_short, "FCLshort")

```

```{r Mering two competitive motifs}
#df_emp$Competition=df_emp$Apparent + df_emp$Exploitative
#df_long$Competition=df_long$Apparent + df_long$Exploitative
#df_mean$Competition=df_mean$Apparent + df_mean$Exploitative
#df_short$Competition=df_short$Apparent + df_short$Exploitative

ScatterV2=function(data, gname, alpha=1){
  g1=ggplot(data, aes(x=Richness, y=Chain), alpha=alpha) + geom_point()+ylim(0,1)+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20))+annotate(geom="text", x=0.5*max(data$Richness), y=0.8, label=paste0('corr.=', round(cor.test(na.omit(data)$Richness, na.omit(data)$Chain, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(na.omit(data)$Richness, na.omit(data)$Chain, method='spearman')$p.value, 3)), size=6)
  g2=ggplot(data, aes(x=Richness, y=Omnivory), alpha=alpha) + geom_point()+ylim(0,1)+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20))+annotate(geom="text", x=0.5*max(data$Richness), y=0.8, label=paste0('corr.=', round(cor.test(na.omit(data)$Richness, na.omit(data)$Omnivory, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(na.omit(data)$Richness, na.omit(data)$Omnivory, method='spearman')$p.value, 3)), size=6)
  g3=ggplot(data, aes(x=Richness, y=Competition), alpha=alpha) + geom_point()+ylim(0,1)+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20))+annotate(geom="text", x=0.5*max(data$Richness), y=0.8, label=paste0('corr.=', round(cor.test(na.omit(data)$Richness, na.omit(data)$Competition, method='spearman')$estimate, 3), ', p.val=',  round(cor.test(na.omit(data)$Richness, na.omit(data)$Competition, method='spearman')$p.value, 3)), size=6)
  g=g1+g2+g3+plot_layout(nrow = 3)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
  ggsave(paste0('ScatterCorrV2_', gname, '.png'), heigh=12, width=8)
}


```


```{r Quantile regression}
library(quantreg)
QuantileReg=function(data, gname){
  #Richness vs Chain
  g1=ggplot(data, aes(x=Richness, y=Chain)) + geom_point()+ylim(0,1)+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20))
  # change abline below to non-parametric ana nonlinear+
  g1=g1+geom_quantile(method = "rqss", quantiles = c(0.1, 0.9), colour="blue", linewidth = 2, alpha = 0.5)
  g1=g1+geom_quantile(method = "rqss", quantiles = c(0.5), colour="green", linewidth = 2.5, alpha = 0.5)
  
  # Richness vs Omnivory
  g2=ggplot(data, aes(x=Richness, y=Omnivory)) + geom_point()+ylim(0,1)+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20))
  # change abline below to non-parametric ana nonlinear+
  g2=g2+geom_quantile(method = "rqss", quantiles = c(0.1, 0.9), colour="blue", linewidth = 2, alpha = 0.5)
  g2=g2+geom_quantile(method = "rqss", quantiles = c(0.5), colour="green", linewidth = 2.5, alpha = 0.5)
  
  # Richness vs Competition
  g3=ggplot(data, aes(x=Richness, y=Competition)) + geom_point()+ylim(0,1)+theme(
    axis.text.x = element_text(size=14),
      axis.title.x = element_text(size=20),
       axis.text.y = element_text(size=14),
      axis.title.y = element_text(size=20))
  # change abline below to non-parametric ana nonlinear+
  g3=g3+geom_quantile(method = "rqss", quantiles = c(0.1, 0.9), colour="blue", linewidth = 2, alpha = 0.5)
  g3=g3+geom_quantile(method = "rqss", quantiles = c(0.5), colour="green", linewidth = 2.5, alpha = 0.5)
  g=g1+g2+g3+plot_layout(nrow = 3)+plot_annotation(tag_levels = "A")&theme(plot.tag = element_text(size = 32))
  ggsave(paste0('QuantileRegression_', gname, '.png'), heigh=12, width=8)
  
}
QuantileReg(df_emp, 'Empirical')
QuantileReg(df_long, 'SimulationLong')
QuantileReg(df_mean, 'SimulationMean')
QuantileReg(df_short, 'SimulationShort')
```